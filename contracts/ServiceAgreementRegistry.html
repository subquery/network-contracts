<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ServiceAgreementRegistry | SubQuery Network API</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/network-contracts/assets/css/0.styles.aa64b011.css" as="style"><link rel="preload" href="/network-contracts/assets/js/app.87a047ab.js" as="script"><link rel="preload" href="/network-contracts/assets/js/2.27a40bc7.js" as="script"><link rel="preload" href="/network-contracts/assets/js/29.909e4505.js" as="script"><link rel="prefetch" href="/network-contracts/assets/js/10.dc2fb91c.js"><link rel="prefetch" href="/network-contracts/assets/js/11.089f3f28.js"><link rel="prefetch" href="/network-contracts/assets/js/12.1a2cee0f.js"><link rel="prefetch" href="/network-contracts/assets/js/13.65bbe297.js"><link rel="prefetch" href="/network-contracts/assets/js/14.ffe4e780.js"><link rel="prefetch" href="/network-contracts/assets/js/15.565d45f4.js"><link rel="prefetch" href="/network-contracts/assets/js/16.502a2abc.js"><link rel="prefetch" href="/network-contracts/assets/js/17.daa31d2a.js"><link rel="prefetch" href="/network-contracts/assets/js/18.2c831974.js"><link rel="prefetch" href="/network-contracts/assets/js/19.88a66e6d.js"><link rel="prefetch" href="/network-contracts/assets/js/20.19d92089.js"><link rel="prefetch" href="/network-contracts/assets/js/21.92efbd71.js"><link rel="prefetch" href="/network-contracts/assets/js/22.80800923.js"><link rel="prefetch" href="/network-contracts/assets/js/23.2ebcae78.js"><link rel="prefetch" href="/network-contracts/assets/js/24.80249bc3.js"><link rel="prefetch" href="/network-contracts/assets/js/25.3b934353.js"><link rel="prefetch" href="/network-contracts/assets/js/26.cfb06d9f.js"><link rel="prefetch" href="/network-contracts/assets/js/27.d0ed7b47.js"><link rel="prefetch" href="/network-contracts/assets/js/28.b37cf957.js"><link rel="prefetch" href="/network-contracts/assets/js/3.dc631073.js"><link rel="prefetch" href="/network-contracts/assets/js/30.af6d54f3.js"><link rel="prefetch" href="/network-contracts/assets/js/31.75511620.js"><link rel="prefetch" href="/network-contracts/assets/js/32.1790e3e4.js"><link rel="prefetch" href="/network-contracts/assets/js/33.7d895206.js"><link rel="prefetch" href="/network-contracts/assets/js/34.98332cb4.js"><link rel="prefetch" href="/network-contracts/assets/js/35.092db0d4.js"><link rel="prefetch" href="/network-contracts/assets/js/36.16c2737f.js"><link rel="prefetch" href="/network-contracts/assets/js/37.eb7412c9.js"><link rel="prefetch" href="/network-contracts/assets/js/38.254dafb8.js"><link rel="prefetch" href="/network-contracts/assets/js/39.6803e9a0.js"><link rel="prefetch" href="/network-contracts/assets/js/4.344717be.js"><link rel="prefetch" href="/network-contracts/assets/js/40.1c61e7d4.js"><link rel="prefetch" href="/network-contracts/assets/js/41.21676a98.js"><link rel="prefetch" href="/network-contracts/assets/js/42.280c4e20.js"><link rel="prefetch" href="/network-contracts/assets/js/43.118aface.js"><link rel="prefetch" href="/network-contracts/assets/js/44.de03f1d9.js"><link rel="prefetch" href="/network-contracts/assets/js/45.7ca3dbb3.js"><link rel="prefetch" href="/network-contracts/assets/js/46.cafa4c3e.js"><link rel="prefetch" href="/network-contracts/assets/js/47.f3cebf03.js"><link rel="prefetch" href="/network-contracts/assets/js/48.6b3b9785.js"><link rel="prefetch" href="/network-contracts/assets/js/49.77625728.js"><link rel="prefetch" href="/network-contracts/assets/js/5.be4723dc.js"><link rel="prefetch" href="/network-contracts/assets/js/50.97cb6565.js"><link rel="prefetch" href="/network-contracts/assets/js/51.8c4ea14d.js"><link rel="prefetch" href="/network-contracts/assets/js/6.c89030cc.js"><link rel="prefetch" href="/network-contracts/assets/js/7.4680987c.js"><link rel="prefetch" href="/network-contracts/assets/js/8.0940ac83.js"><link rel="prefetch" href="/network-contracts/assets/js/9.8f7e1582.js">
    <link rel="stylesheet" href="/network-contracts/assets/css/0.styles.aa64b011.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/network-contracts/" class="home-link router-link-active"><!----> <span class="site-name">SubQuery Network API</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="serviceagreementregistry"><a href="#serviceagreementregistry" class="header-anchor">#</a> ServiceAgreementRegistry</h2> <h3 id="overview"><a href="#overview" class="header-anchor">#</a> Overview</h3> <p>This contract tracks all service Agreements for Indexers and Consumers.
For now, Consumer can accept the plan created by Indexer from Plan Manager to generate close service agreement.
Indexer can also accept Purchase Offer created by Consumer from purchase offer market to generate close service agreement.
All generated service agreement need to register in this contract by calling establishServiceAgreement(). After this all SQT Toaken
from agreements will be temporary hold in this contract, and approve reward distributor contract to take and distribute these Token.</p> <h3 id="states"><a href="#states" class="header-anchor">#</a> STATES</h3> <h3 id="settings"><a href="#settings" class="header-anchor">#</a> settings</h3> <p>ISettings contract which stores SubQuery network contracts address</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">contract</span> <span class="token class-name">ISettings</span> settings
</code></pre></div><h3 id="nextserviceagreementid"><a href="#nextserviceagreementid" class="header-anchor">#</a> nextServiceAgreementId</h3> <p>the id for next ServiceAgreement</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token builtin">uint256</span> nextServiceAgreementId
</code></pre></div><h3 id="closedserviceagreements"><a href="#closedserviceagreements" class="header-anchor">#</a> closedServiceAgreements</h3> <p>ServiceAgreementId =&gt; AgreementInfo</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> <span class="token operator">=&gt;</span> <span class="token keyword">struct</span> <span class="token class-name">ClosedServiceAgreementInfo</span><span class="token punctuation">)</span> closedServiceAgreements
</code></pre></div><h3 id="establisherwhitelist"><a href="#establisherwhitelist" class="header-anchor">#</a> establisherWhitelist</h3> <p>address can establishServiceAgreement, for now only PurchaceOfferMarket and PlanManager addresses</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> establisherWhitelist
</code></pre></div><p>Emitted when closed service agreement established</p> <h3 id="closedagreementcreated"><a href="#closedagreementcreated" class="header-anchor">#</a> ClosedAgreementCreated</h3> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">event</span> <span class="token function">ClosedAgreementCreated</span><span class="token punctuation">(</span><span class="token builtin">address</span> consumer<span class="token punctuation">,</span> <span class="token builtin">address</span> indexer<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> deploymentId<span class="token punctuation">,</span> <span class="token builtin">uint256</span> serviceAgreementId<span class="token punctuation">)</span>
</code></pre></div><p>Initialize this contract. Load establisherWhitelist.</p> <h3 id="initialize"><a href="#initialize" class="header-anchor">#</a> initialize</h3> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token keyword">contract</span> <span class="token class-name">ISettings</span> _settings<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> _whitelist<span class="token punctuation">)</span> <span class="token keyword">external</span>
</code></pre></div><p>See {IERC165-supportsInterface}.</p> <h3 id="supportsinterface"><a href="#supportsinterface" class="header-anchor">#</a> supportsInterface</h3> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">supportsInterface</span><span class="token punctuation">(</span><span class="token builtin">bytes4</span> interfaceId<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="setsettings"><a href="#setsettings" class="header-anchor">#</a> setSettings</h3> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">setSettings</span><span class="token punctuation">(</span><span class="token keyword">contract</span> <span class="token class-name">ISettings</span> _settings<span class="token punctuation">)</span> <span class="token keyword">external</span>
</code></pre></div><h3 id="addestablisher"><a href="#addestablisher" class="header-anchor">#</a> addEstablisher</h3> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">addEstablisher</span><span class="token punctuation">(</span><span class="token builtin">address</span> establisher<span class="token punctuation">)</span> <span class="token keyword">external</span>
</code></pre></div><h3 id="removeestablisher"><a href="#removeestablisher" class="header-anchor">#</a> removeEstablisher</h3> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">removeEstablisher</span><span class="token punctuation">(</span><span class="token builtin">address</span> establisher<span class="token punctuation">)</span> <span class="token keyword">external</span>
</code></pre></div><h3 id="aftertokentransfer"><a href="#aftertokentransfer" class="header-anchor">#</a> _afterTokenTransfer</h3> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">_afterTokenTransfer</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">from</span><span class="token punctuation">,</span> <span class="token builtin">address</span> to<span class="token punctuation">,</span> <span class="token builtin">uint256</span> tokenId<span class="token punctuation">,</span> <span class="token builtin">uint256</span> batchSize<span class="token punctuation">)</span> <span class="token keyword">internal</span>
</code></pre></div><h3 id="createclosedserviceagreement"><a href="#createclosedserviceagreement" class="header-anchor">#</a> createClosedServiceAgreement</h3> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">createClosedServiceAgreement</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ClosedServiceAgreementInfo</span> agreement<span class="token punctuation">,</span> <span class="token builtin">bool</span> checkThreshold<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span>
</code></pre></div><p>Establish the generated service agreement.
For now only establish the close service agreement generated from PlanManager and PurchsaseOfferMarket.
This function is called by PlanManager or PurchsaseOfferMarket when close service agreement generated,
it temporary hold the SQT Token from these agreements, approve and nodify reward distributor contract to take and
distribute these Token.
All agreements register to this contract through this method.
SQT need to be transfered before calling this function.
When new agreement come we need to track the sumDailyReward of Indexer. In our design there is an upper limit
on the rewards indexer can earn every day, and the limit will increase with the increase of the total staked
amount of that indexer. This design can ensure our Customer to obtain high quality of service from Indexerï¼Œ
at the same time, it also encourages Indexer to provide better more stable services.</p> <h3 id="establishserviceagreement"><a href="#establishserviceagreement" class="header-anchor">#</a> _establishServiceAgreement</h3> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">_establishServiceAgreement</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> agreementId<span class="token punctuation">,</span> <span class="token builtin">bool</span> checkThreshold<span class="token punctuation">)</span> <span class="token keyword">internal</span>
</code></pre></div><p>A function allow Consumer call to renew its unexpired closed service agreement.
We only allow the the agreement generated from PlanManager renewable which is created
by Indexer and accepted by Consumer. We use the status planId in agreement to determine
whether the agreement is renewable, since only the agreement generated from PlanManager
come with the PlanId.
Indexer can be prevente the agreement rennew by inactive the plan which bound to it.
Consumer must renew befor the agreement expired.</p> <h3 id="renewagreement"><a href="#renewagreement" class="header-anchor">#</a> renewAgreement</h3> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">renewAgreement</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> agreementId<span class="token punctuation">)</span> <span class="token keyword">external</span>
</code></pre></div><h3 id="closedserviceagreementexpired"><a href="#closedserviceagreementexpired" class="header-anchor">#</a> closedServiceAgreementExpired</h3> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">closedServiceAgreementExpired</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> agreementId<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="getclosedserviceagreement"><a href="#getclosedserviceagreement" class="header-anchor">#</a> getClosedServiceAgreement</h3> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">getClosedServiceAgreement</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> agreementId<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ClosedServiceAgreementInfo</span><span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/network-contracts/assets/js/app.87a047ab.js" defer></script><script src="/network-contracts/assets/js/2.27a40bc7.js" defer></script><script src="/network-contracts/assets/js/29.909e4505.js" defer></script>
  </body>
</html>
